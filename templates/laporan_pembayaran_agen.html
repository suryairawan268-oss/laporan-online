{% extends "base.html" %}
{% block title %}Laporan Pembayaran Agen - SPBE Migas{% endblock %}
{% block page_title %}Laporan Pembayaran Agen{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-primary mb-2">
                    <i class="fas fa-credit-card me-2"></i>Laporan Pembayaran Agen
                </h2>
                <p class="text-muted">Kelola dan pantau pembayaran agen distribusi</p>
            </div>
            <div class="d-flex gap-3">
                <a href="/agen" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Tambah Pembayaran
                </a>
                <a href="/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Kembali
                </a>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card total-payment">
                <div class="card-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="card-content">
                    <div class="card-value">
                        Rp {{ "{:,}".format((pembayaran_list|sum(attribute='harga_pertabung')|int * pembayaran_list|sum(attribute='jumlah_turun')|int) if pembayaran_list else 0) }}
                    </div>
                    <div class="card-label">Total Pembayaran</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card total-transaction">
                <div class="card-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="card-content">
                    <div class="card-value">{{ pembayaran_list|length }}</div>
                    <div class="card-label">Total Transaksi</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card status-paid">
                <div class="card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-content">
                    <div class="card-value">{{ pembayaran_list|selectattr('status', 'equalto', 'Paid')|list|length }}/{{ pembayaran_list|length }}</div>
                    <div class="card-label">Status Paid</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="summary-card total-tabung">
                <div class="card-icon">
                    <i class="fas fa-gas-pump"></i>
                </div>
                <div class="card-content">
                    <div class="card-value">{{ pembayaran_list|map(attribute='jumlah_turun')|sum or 0 }}</div>
                    <div class="card-label">Total Tabung</div>
                </div>
            </div>
        </div>
    </div>

    <div class="filter-section mb-4">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Filter Status:</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">Semua Status</option>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Unpaid">Unpaid</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Cari Data:</label>
                        <div class="search-box">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="form-control ps-5" id="searchInput" 
                                   placeholder="Cari nama agen, driver, atau jenis tabung...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary flex-fill" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                            <button class="btn btn-success flex-fill" onclick="exportData()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Data Pembayaran Agen
                </h5>
                <div class="table-info">
                    <small class="text-muted">
                        Menampilkan <span id="showingCount">0</span> dari <span id="totalCount">{{ pembayaran_list|length }}</span> data
                    </small>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 6%">ID</th>
                            <th style="width: 16%">Agen & Driver</th>
                            <th style="width: 13%">Jenis Tabung</th>
                            <th style="width: 10%" class="text-end">Harga/Unit</th>
                            <th style="width: 7%" class="text-center">Jumlah</th>
                            <th style="width: 13%" class="text-end">Total Bayar</th>
                            <th style="width: 10%" class="text-center">Tanggal</th>
                            <th style="width: 10%" class="text-center">Status & Bukti</th>
                            <th style="width: 15%" class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        {% for row in pembayaran_list %}
                        <tr class="payment-row" 
                            data-status="{{ row.status or 'Unpaid' }}" 
                            data-search="{{ (row.nama_agen or '') + ' ' + (row.nama_driver or '') + ' ' + (row.jenis_tabung or '') }}">
                            <td>
                                <span class="id-badge">{{ row.id }}</span>
                            </td>
                            <td>
                                <div class="agen-info">
                                    <div class="agen-avatar">
                                        {{ (row.nama_agen or 'A')[0]|upper }}
                                    </div>
                                    <div class="agen-details">
                                        <div class="agen-name">{{ row.nama_agen or '-' }}</div>
                                        <div class="driver-name">
                                            <i class="fas fa-user-tie me-1"></i>{{ row.nama_driver or '-' }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="tabung-badge">
                                    <i class="fas fa-gas-pump me-1"></i>{{ row.jenis_tabung or '-' }}
                                </span>
                            </td>
                            <td class="text-end">
                                <div class="price-display">
                                    Rp {{ "{:,}".format(row.harga_pertabung|int) if row.harga_pertabung else 0 }}
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="quantity-badge">{{ row.jumlah_turun or 0 }}</span>
                            </td>
                            <td class="text-end">
                                <div class="total-payment">
                                    Rp {{ "{:,}".format((row.harga_pertabung * row.jumlah_turun)|int) if row.harga_pertabung and row.jumlah_turun else 0 }}
                                </div>
                            </td>
                            <td class="text-center">
                                {% if row.tanggal_pengiriman %}
                                    <div class="date-display">
                                        {{ row.tanggal_pengiriman.strftime("%d/%m/%Y") }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="status-bukti">
                                    <div class="status-badge mb-1">
                                        {% if row.status == "Paid" %}
                                            <span class="badge status-paid">
                                                <i class="fas fa-check-circle me-1"></i>Paid
                                            </span>
                                        {% else %}
                                            <span class="badge status-pending">
                                                <i class="fas fa-clock me-1"></i>{{ row.status or "Pending" }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="bukti-action">
                                        {% if row.bukti %}
<a href="#" 
   class="btn btn-sm btn-outline-info" 
   data-bs-toggle="modal" 
   data-bs-target="#buktiPreviewModal"
   onclick="showBuktiPreview('/uploads/{{ row.bukti }}')">
    <i class="fas fa-eye me-1"></i>Bukti
</a>
                                        {% else %}
                                            <span class="text-muted small">
                                                <i class="fas fa-minus-circle me-1"></i>No File
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <a href="/agen/edit/{{ row.id }}" 
                                       class="btn btn-sm btn-outline-warning mb-1" 
                                       title="Edit Pembayaran">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </a>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmDelete({{ row.id }}, '{{ row.nama_agen }}')" 
                                            title="Hapus Pembayaran">
                                        <i class="fas fa-trash me-1"></i>Hapus
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center py-5">
                                <div class="empty-state-inline">
                                    <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">Belum ada data pembayaran</h6>
                                    <p class="text-muted small">Tambah pembayaran agen untuk mulai mengelola transaksi</p>
                                    <a href="/agen" class="btn btn-primary btn-sm">
                                        <i class="fas fa-plus me-1"></i>Tambah Pembayaran
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Preview Bukti Pembayaran -->
<div class="modal fade" id="buktiPreviewModal" tabindex="-1" aria-labelledby="buktiPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buktiPreviewModalLabel">Pratinjau Bukti Pembayaran</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" alt="Bukti Pembayaran" class="img-fluid rounded">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <a id="downloadLink" href="" target="_blank" class="btn btn-primary">
                    <i class="fas fa-download me-1"></i>Unduh
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi Hapus -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Konfirmasi Hapus
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                </div>
                <p class="mb-2">Apakah Anda yakin ingin menghapus pembayaran untuk:</p>
                <p class="fw-bold text-danger mb-3" id="deleteItemName"></p>
                <p class="text-muted small">Data yang dihapus tidak dapat dikembalikan!</p>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Batal
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Ya, Hapus
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Page Header */
    .page-header {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    /* Summary Cards */
    .summary-card {
        background: var(--pure-white);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border-gray);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
        height: 100%;
    }

    .summary-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .summary-card .card-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: var(--pure-white);
        flex-shrink: 0;
    }

    .total-payment .card-icon {
        background: var(--primary-green);
    }

    .total-transaction .card-icon {
        background: var(--primary-blue);
    }

    .status-paid .card-icon {
        background: var(--success-green);
    }

    .total-tabung .card-icon {
        background: var(--warning-orange);
    }

    .summary-card .card-content {
        flex: 1;
    }

    .summary-card .card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark-gray);
        margin-bottom: 0.25rem;
    }

    .summary-card .card-label {
        color: var(--medium-gray);
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Filter Section */
    .filter-section .search-box {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--light-gray);
        z-index: 2;
    }

    .search-box input {
        padding-left: 3rem;
    }

    /* Table Styles */
    .table thead th {
        background: var(--dark-gray);
        color: var(--pure-white);
        font-weight: 600;
        padding: 1rem;
        border: none;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: var(--border-gray);
    }

    .table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    /* Table Content */
    .id-badge {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary-blue);
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .agen-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .agen-avatar {
        width: 35px;
        height: 35px;
        background: var(--primary-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--pure-white);
        font-weight: 600;
        font-size: 0.9rem;
    }

    .agen-name {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 0.25rem;
    }

    .driver-name {
        color: var(--medium-gray);
        font-size: 0.85rem;
    }

    .tabung-badge {
        background: var(--info-cyan);
        color: var(--pure-white);
        padding: 0.5rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
    }

    .price-display {
        font-weight: 600;
        color: var(--dark-gray);
        font-size: 0.95rem;
    }

    .quantity-badge {
        background: var(--warning-orange);
        color: var(--pure-white);
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .total-payment {
        font-weight: 700;
        color: var(--primary-green);
        font-size: 1rem;
    }

    .date-display {
        color: var(--medium-gray);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .status-bukti {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .status-paid {
        background: var(--success-green);
        color: var(--pure-white);
    }

    .status-pending {
        background: var(--warning-orange);
        color: var(--pure-white);
    }

    .bukti-action .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: center;
    }

    .action-buttons .btn {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        min-width: 70px;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
    }

    .action-buttons .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .btn-outline-warning:hover {
        background-color: #f59e0b;
        border-color: #f59e0b;
        color: white;
    }

    .btn-outline-danger:hover {
        background-color: #dc2626;
        border-color: #dc2626;
        color: white;
    }

    /* Empty State */
    .empty-state-inline {
        padding: 3rem 2rem;
    }

    /* Modal Enhancements */
    .modal-content {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }

    #previewImage {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
    }

    #deleteConfirmModal .modal-content {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header .d-flex {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .summary-card {
            margin-bottom: 1rem;
        }

        .table-responsive {
            border-radius: 0.75rem;
        }

        .agen-info {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .status-bukti {
            flex-direction: row;
            justify-content: center;
            gap: 0.5rem;
        }

        .action-buttons {
            flex-direction: row;
            gap: 0.5rem;
            justify-content: center;
        }

        .action-buttons .btn {
            min-width: 60px;
            font-size: 0.75rem;
        }
    }

    /* Custom Variables (you may need to define these in your CSS) */
    :root {
        --pure-white: #ffffff;
        --border-gray: #e5e7eb;
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --primary-green: #10b981;
        --primary-blue: #3b82f6;
        --success-green: #059669;
        --warning-orange: #f59e0b;
        --info-cyan: #06b6d4;
        --dark-gray: #374151;
        --medium-gray: #6b7280;
        --light-gray: #9ca3af;
    }
</style>

<script>
    let deleteId = null;

    // Filter functionality
    function filterTable() {
        const statusFilter = document.getElementById('statusFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.payment-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            const searchText = row.getAttribute('data-search').toLowerCase();
            
            const matchesStatus = !statusFilter || status === statusFilter;
            const matchesSearch = !searchTerm || searchText.includes(searchTerm);
            
            if (matchesStatus && matchesSearch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update showing count
        document.getElementById('showingCount').textContent = visibleCount;
    }

    function resetFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchInput').value = '';
        filterTable();
    }

    function exportData() {
        const table = document.querySelector('table');
        const rows = [];
        
        // Headers
        const headers = ['ID', 'Nama Agen', 'Driver', 'Jenis Tabung', 'Harga per Unit', 'Jumlah', 'Total Bayar', 'Tanggal', 'Status'];
        rows.push(headers.join(','));
        
        // Visible data rows
        const visibleRows = Array.from(document.querySelectorAll('.payment-row')).filter(row => row.style.display !== 'none');
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [
                cells[0].textContent.trim(),
                cells[1].querySelector('.agen-name').textContent.trim(),
                cells[1].querySelector('.driver-name').textContent.replace('👔', '').trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim(),
                cells[6].textContent.trim(),
                cells[7].querySelector('.badge').textContent.trim()
            ];
            rows.push(rowData.join(','));
        });
        
        // Create and download CSV
        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = 'laporan_pembayaran_agen_' + new Date().toISOString().slice(0,10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Function to handle modal preview
    function showBuktiPreview(buktiUrl) {
        const modalImage = document.getElementById('previewImage');
        const downloadLink = document.getElementById('downloadLink');

        modalImage.src = buktiUrl;
        downloadLink.href = buktiUrl;
    }

    // Function to show delete confirmation modal
    function confirmDelete(id, namaAgen) {
        deleteId = id;
        document.getElementById('deleteItemName').textContent = namaAgen || 'Item ini';
        
        // Show the modal
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        deleteModal.show();
    }

    // Function to handle actual delete
    function executeDelete() {
        if (!deleteId) return;

        // Show loading state
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Menghapus...';
        confirmBtn.disabled = true;





        
        // Make delete request
fetch(`/api/pembayaran-agen/${deleteId}`, {
    method: 'DELETE',
    headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
    }
})
        .then(response => {
            if (response.ok) {
                // Success - reload page or remove row
                location.reload();
            } else {
                throw new Error('Gagal menghapus data');
            }
        })
        .catch(error => {
            alert('Terjadi kesalahan: ' + error.message);
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        });
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('statusFilter').addEventListener('change', filterTable);
        document.getElementById('searchInput').addEventListener('input', filterTable);
        
        // Delete confirmation button
        document.getElementById('confirmDeleteBtn').addEventListener('click', executeDelete);
        
        // Initial count
        filterTable();
    });
</script>

{% endblock %}