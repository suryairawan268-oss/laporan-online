{% extends "base.html" %}
{% block title %}Data Karyawan - SPBE Migas{% endblock %}
{% block page_title %}Manajemen Data Karyawan{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="fw-bold text-dark mb-2">Manajemen Data Karyawan</h2>
                <p class="text-muted">Kelola data karyawan perusahaan SPBE Migas</p>
            </div>
            <div>
                <button class="btn btn-outline-success" onclick="exportData()">
                    <i class="fas fa-file-excel me-2"></i>Export Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0" id="formTitle">
                <i class="fas fa-user-plus me-2"></i>Form Tambah Karyawan
            </h5>
        </div>
        <div class="card-body">
            <form action="/karyawan/simpan" method="post">
                <!-- Hidden untuk edit -->
                <input type="hidden" id="edit_id" name="edit_id">

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">ID Karyawan / NIK</label>
                        <input type="text" id="nik" name="nik" class="form-control" 
                               placeholder="Masukkan ID atau NIK" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Nama Lengkap</label>
                        <input type="text" id="nama" name="nama" class="form-control" 
                               placeholder="Masukkan nama lengkap" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Jabatan</label>
                        <input type="text" id="jabatan" name="jabatan" class="form-control" 
                               placeholder="Masukkan jabatan">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Kontak</label>
                        <input type="text" id="kontak" name="kontak" class="form-control" 
                               placeholder="Nomor HP / WhatsApp">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Keterangan</label>
                        <textarea id="keterangan" name="keterangan" class="form-control" rows="2" 
                                  placeholder="Tambahkan keterangan tambahan..."></textarea>
                    </div>
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="submit" id="submitBtn" class="btn btn-primary px-4">
                                <i class="fas fa-plus me-1"></i>Tambah Karyawan
                            </button>
                            <button type="button" class="btn btn-outline-secondary px-4" onclick="resetForm()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Table Section -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Daftar Karyawan
                </h5>
                <div class="search-box-header">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="form-control form-control-sm ps-4" 
                           placeholder="Cari karyawan..." style="width: 250px;">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 12%">ID / NIK</th>
                            <th style="width: 22%">Nama</th>
                            <th style="width: 18%">Jabatan</th>
                            <th style="width: 15%">Kontak</th>
                            <th style="width: 23%">Keterangan</th>
                            <th style="width: 10%" class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                        {% for k in karyawan %}
                        <tr class="employee-row" 
                            data-search="{{ (k.nik or '') + ' ' + (k.nama or '') + ' ' + (k.jabatan or '') + ' ' + (k.kontak or '') }}">
                            <td>
                                <span class="id-badge">{{ k.nik or '-' }}</span>
                            </td>
                            <td>
                                <div class="employee-info">
                                    <div class="employee-avatar">
                                        {{ k.nama[0].upper() if k.nama else 'K' }}
                                    </div>
                                    <div class="employee-details">
                                        <div class="employee-name">{{ k.nama or '-' }}</div>
                                        <small class="text-muted">Karyawan</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if k.jabatan %}
                                    <span class="position-badge">
                                        <i class="fas fa-briefcase me-1"></i>{{ k.jabatan }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if k.kontak %}
                                    <div class="contact-info">
                                        <i class="fas fa-phone me-1 text-muted"></i>
                                        <span>{{ k.kontak }}</span>
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if k.keterangan %}
                                    <div class="keterangan-text" title="{{ k.keterangan }}">
                                        {{ k.keterangan[:50] }}{% if k.keterangan|length > 50 %}...{% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-sm btn-outline-primary" title="Edit Karyawan"
                                            onclick="editKaryawan('{{ k.id }}','{{ k.nik }}','{{ k.nama }}','{{ k.jabatan }}','{{ k.kontak }}','{{ k.keterangan }}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="/karyawan/hapus/{{ k.id }}" class="btn btn-sm btn-outline-danger" title="Hapus Karyawan"
                                       onclick="return confirm('Apakah Anda yakin ingin menghapus karyawan {{ k.nama }}?')">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <div class="empty-state-inline">
                                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">Belum ada data karyawan</h6>
                                    <p class="text-muted small">Tambah karyawan baru untuk mulai mengelola data</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Table Footer with Stats -->
        {% if karyawan %}
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                    Total: <span id="totalEmployees">{{ karyawan|length }}</span> karyawan
                </small>
                <small class="text-muted">
                    Menampilkan: <span id="showingEmployees">{{ karyawan|length }}</span> dari <span id="totalCount">{{ karyawan|length }}</span> data
                </small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
    /* Page Header */
    .page-header {
        background: var(--pure-white);
        border: 1px solid var(--border-gray);
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: var(--shadow-md);
    }

    /* Search Box in Header */
    .search-box-header {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--light-gray);
        z-index: 2;
        font-size: 0.9rem;
    }

    /* Table Styles */
    .table thead th {
        background: var(--dark-gray);
        color: var(--pure-white);
        font-weight: 600;
        padding: 1rem;
        border: none;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: var(--border-gray);
    }

    .table tbody tr:hover {
        background: rgba(59, 130, 246, 0.05);
    }

    /* Employee Info Display */
    .employee-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .employee-avatar {
        width: 35px;
        height: 35px;
        background: var(--primary-blue);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--pure-white);
        font-weight: 600;
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .employee-name {
        font-weight: 600;
        color: var(--dark-gray);
        margin-bottom: 0.1rem;
    }

    .id-badge {
        background: rgba(59, 130, 246, 0.1);
        color: var(--primary-blue);
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .position-badge {
        background: var(--primary-green);
        color: var(--pure-white);
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.85rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
    }

    .contact-info {
        color: var(--medium-gray);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }

    .keterangan-text {
        color: var(--dark-gray);
        font-size: 0.9rem;
        line-height: 1.3;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .action-buttons .btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    .action-buttons .btn:hover {
        transform: translateY(-1px);
    }

    /* Empty State */
    .empty-state-inline {
        padding: 2rem;
    }

    /* Form Styling */
    .form-label {
        color: var(--dark-gray);
        margin-bottom: 0.5rem;
    }

    .form-control:focus {
        border-color: var(--secondary-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header .d-flex {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .search-box-header {
            width: 100%;
            margin-top: 1rem;
        }

        .search-box-header input {
            width: 100% !important;
        }

        .employee-info {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }

        .action-buttons {
            flex-direction: column;
            gap: 0.25rem;
        }

        .table-responsive {
            font-size: 0.85rem;
        }

        .card-footer .d-flex {
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }
    }
</style>

<script>
    // Edit Karyawan Function
    function editKaryawan(id, nik, nama, jabatan, kontak, keterangan) {
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>Edit Karyawan';
        document.getElementById('edit_id').value = id;
        document.getElementById('nik').value = nik || '';
        document.getElementById('nama').value = nama || '';
        document.getElementById('jabatan').value = jabatan || '';
        document.getElementById('kontak').value = kontak || '';
        document.getElementById('keterangan').value = keterangan || '';
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Update Karyawan';
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-warning');
        
        // Scroll to form
        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    // Reset Form Function
    function resetForm() {
        document.getElementById('formTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Form Tambah Karyawan';
        document.getElementById('edit_id').value = '';
        document.getElementById('nik').value = '';
        document.getElementById('nama').value = '';
        document.getElementById('jabatan').value = '';
        document.getElementById('kontak').value = '';
        document.getElementById('keterangan').value = '';
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.innerHTML = '<i class="fas fa-plus me-1"></i>Tambah Karyawan';
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }

    // Search Function
    function searchEmployees() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.employee-row');
        let visibleCount = 0;

        rows.forEach(row => {
            const searchData = row.getAttribute('data-search').toLowerCase();
            
            if (searchData.includes(searchTerm)) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });

        // Update showing count
        const showingElement = document.getElementById('showingEmployees');
        if (showingElement) {
            showingElement.textContent = visibleCount;
        }
    }

    // Export Function
    function exportData() {
        const table = document.querySelector('table');
        const rows = [];
        
        // Headers
        const headers = ['NIK', 'Nama', 'Jabatan', 'Kontak', 'Keterangan'];
        rows.push(headers.join(','));
        
        // Visible data rows
        const visibleRows = Array.from(document.querySelectorAll('.employee-row')).filter(row => row.style.display !== 'none');
        visibleRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = [
                cells[0].textContent.trim(),
                cells[1].querySelector('.employee-name').textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim(),
                cells[4].textContent.trim()
            ];
            rows.push(rowData.join(','));
        });
        
        // Create and download CSV
        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        a.href = url;
        a.download = 'data_karyawan_spbe_' + new Date().toISOString().slice(0,10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('searchInput').addEventListener('input', searchEmployees);
    });
</script>

{% endblock %}